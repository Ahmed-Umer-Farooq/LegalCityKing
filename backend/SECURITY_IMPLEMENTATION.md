# Legal City King - Enterprise Security Implementation\n\n## Overview\n\nThis document outlines the comprehensive security implementation for the Legal City King application, featuring enterprise-grade security measures including JWT authentication, RBAC authorization, input validation, XSS protection, CSRF protection, rate limiting, secure payment processing, and comprehensive audit logging.\n\n## Security Features Implemented\n\n### 1. Authentication & Authorization\n\n#### JWT Token Management\n- **Location**: `middleware/security.js`\n- **Features**:\n  - Short-lived access tokens (1 hour default)\n  - Secure token generation with strong secrets\n  - Token verification with error handling\n  - Automatic token expiration\n\n```javascript\n// Usage example\nconst { generateToken, verifyToken } = require('./middleware/security');\n\nconst token = generateToken({ id: user.id, email: user.email, role: user.role });\nconst decoded = verifyToken(token);\n```\n\n#### Role-Based Access Control (RBAC)\n- **Location**: `config/rbac_model.conf`, `config/rbac_policy.csv`\n- **Features**:\n  - Fine-grained permission control\n  - Role hierarchy (admin > lawyer > user > client)\n  - Resource-based access control\n  - Dynamic policy enforcement\n\n```javascript\n// Usage example\nconst { authorize } = require('./middleware/security');\n\nrouter.post('/api/admin/users', \n  authenticateToken,\n  authorize('/api/admin/*', 'POST'),\n  handler\n);\n```\n\n### 2. Input Validation & Sanitization\n\n#### Comprehensive Validation\n- **Location**: `middleware/validation.js`\n- **Features**:\n  - Schema-based validation\n  - SQL injection prevention\n  - XSS attack prevention\n  - Input sanitization\n  - File upload validation\n\n```javascript\n// Usage example\nconst { validateUser, validatePayment } = require('./middleware/validation');\n\nrouter.post('/api/users', validateUser, createUser);\nrouter.post('/api/payments', validatePayment, processPayment);\n```\n\n#### Validation Schemas\n- User registration validation\n- Lawyer profile validation\n- Payment data validation\n- Blog content validation\n- Case management validation\n\n### 3. Security Headers & Protection\n\n#### Helmet.js Configuration\n- **Location**: `middleware/security.js`\n- **Features**:\n  - Content Security Policy (CSP)\n  - HTTP Strict Transport Security (HSTS)\n  - X-Frame-Options protection\n  - X-Content-Type-Options\n  - Referrer Policy\n\n#### XSS Protection\n- Server-side input sanitization\n- DOMPurify integration\n- Content filtering\n- Script injection prevention\n\n#### CSRF Protection\n- Token-based CSRF protection\n- Session-based token storage\n- Automatic token validation\n- Secure token generation\n\n### 4. Rate Limiting\n\n#### Multi-tier Rate Limiting\n- **Location**: `middleware/security.js`\n- **Tiers**:\n  - General API: 100 requests/15 minutes\n  - Authentication: 5 attempts/15 minutes\n  - Payments: 10 attempts/hour\n  - Strict endpoints: 20 requests/15 minutes\n\n```javascript\n// Usage example\nconst { authLimiter, paymentLimiter } = require('./middleware/security');\n\nrouter.post('/api/auth/login', authLimiter, loginHandler);\nrouter.post('/api/payments', paymentLimiter, paymentHandler);\n```\n\n### 5. Secure Payment Processing\n\n#### Stripe Integration\n- **Location**: `middleware/stripe.js`\n- **Features**:\n  - Webhook signature verification\n  - Payment intent security\n  - Transaction logging\n  - Fraud detection\n  - PCI compliance\n\n```javascript\n// Usage example\nconst { processSecurePayment, verifyStripeSignature } = require('./middleware/stripe');\n\nrouter.post('/api/payments', processSecurePayment, createPayment);\nrouter.post('/api/stripe/webhook', verifyStripeSignature, handleWebhook);\n```\n\n### 6. Password Security\n\n#### Bcrypt Implementation\n- **Salt rounds**: 12 (configurable)\n- **Password requirements**:\n  - Minimum 8 characters\n  - Uppercase and lowercase letters\n  - Numbers and special characters\n  - Pattern validation\n\n```javascript\n// Usage example\nconst { hashPassword, verifyPassword } = require('./middleware/security');\n\nconst hashedPassword = await hashPassword(plainPassword);\nconst isValid = await verifyPassword(plainPassword, hashedPassword);\n```\n\n### 7. Comprehensive Logging\n\n#### Winston Logger\n- **Location**: `middleware/security.js`\n- **Features**:\n  - Structured JSON logging\n  - Multiple log levels\n  - File and console output\n  - Security event logging\n  - Error tracking\n\n#### Audit Logging\n- Authentication events\n- Authorization failures\n- Payment transactions\n- Data access events\n- Security violations\n\n```javascript\n// Usage example\nconst { logger, auditLog } = require('./middleware/security');\n\nlogger.info('User action completed', { userId, action });\nauditLog('payment_processed', { userId, amount, ip });\n```\n\n### 8. CORS Configuration\n\n#### Secure CORS Setup\n- **Location**: `middleware/security.js`\n- **Features**:\n  - Origin validation\n  - Credential support\n  - Method restrictions\n  - Header validation\n\n## Implementation Guide\n\n### 1. Basic Route Protection\n\n```javascript\nconst express = require('express');\nconst { authenticateToken, requireRole } = require('./middleware/auth');\nconst { validateUser } = require('./middleware/validation');\nconst { generalLimiter } = require('./middleware/security');\n\nconst router = express.Router();\n\n// Apply rate limiting\nrouter.use(generalLimiter);\n\n// Protected route with validation\nrouter.post('/api/users', \n  authenticateToken,\n  requireRole('admin'),\n  validateUser,\n  createUserHandler\n);\n```\n\n### 2. Payment Route Security\n\n```javascript\nconst { \n  authenticateToken, \n  requirePaymentAccess \n} = require('./middleware/auth');\nconst { validatePayment } = require('./middleware/validation');\nconst { processSecurePayment } = require('./middleware/stripe');\nconst { paymentLimiter } = require('./middleware/security');\n\nrouter.post('/api/payments',\n  paymentLimiter,\n  authenticateToken,\n  requirePaymentAccess,\n  validatePayment,\n  processSecurePayment,\n  createPaymentHandler\n);\n```\n\n### 3. Admin Route Protection\n\n```javascript\nconst { authenticateToken, requireAdmin } = require('./middleware/auth');\nconst { authorize } = require('./middleware/security');\n\nrouter.get('/api/admin/users',\n  authenticateToken,\n  requireAdmin,\n  authorize('/api/admin/*', 'GET'),\n  getAdminUsersHandler\n);\n```\n\n## Configuration\n\n### Environment Variables\n\nCopy `.env.security.example` to `.env` and configure:\n\n```bash\n# Security Configuration\nJWT_SECRET=your-super-secure-jwt-secret\nSESSION_SECRET=your-session-secret\nSTRIPE_SECRET_KEY=sk_test_your_stripe_key\nSTRIPE_WEBHOOK_SECRET=whsec_your_webhook_secret\nCHAT_ENCRYPTION_KEY=your-32-character-encryption-key\n\n# Rate Limiting\nRATE_LIMIT_WINDOW_MS=900000\nRATE_LIMIT_MAX_REQUESTS=100\nAUTH_RATE_LIMIT_MAX=5\n\n# Security Features\nNODE_ENV=production\nHELMET_ENABLED=true\nCSRF_PROTECTION_ENABLED=true\nXSS_PROTECTION_ENABLED=true\n```\n\n### RBAC Policy Configuration\n\nEdit `config/rbac_policy.csv` to modify permissions:\n\n```csv\np, admin, /api/admin/*, *\np, lawyer, /api/lawyer/*, *\np, lawyer, /api/payments/create, POST\np, user, /api/user/*, *\np, user, /api/payments/view, GET\n```\n\n## Security Best Practices\n\n### 1. Development vs Production\n\n- **Development**: Security features are configurable for easier testing\n- **Production**: All security features should be enabled\n\n### 2. Key Management\n\n- Use strong, unique secrets for each environment\n- Rotate keys regularly\n- Store secrets securely (environment variables, not code)\n\n### 3. Monitoring\n\n- Monitor security logs regularly\n- Set up alerts for suspicious activities\n- Track authentication failures\n- Monitor payment transactions\n\n### 4. Regular Updates\n\n- Keep dependencies updated\n- Monitor security advisories\n- Perform regular security audits\n- Test security measures regularly\n\n## Testing Security Features\n\n### 1. Authentication Testing\n\n```bash\n# Test login with invalid credentials\ncurl -X POST http://localhost:5001/api/auth/login \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\":\"test@example.com\",\"password\":\"wrong\"}'\n\n# Test protected route without token\ncurl -X GET http://localhost:5001/api/admin/users\n```\n\n### 2. Rate Limiting Testing\n\n```bash\n# Test rate limiting (run multiple times quickly)\nfor i in {1..10}; do\n  curl -X POST http://localhost:5001/api/auth/login \\\n    -H \"Content-Type: application/json\" \\\n    -d '{\"email\":\"test@example.com\",\"password\":\"test\"}'\ndone\n```\n\n### 3. Validation Testing\n\n```bash\n# Test XSS protection\ncurl -X POST http://localhost:5001/api/users \\\n  -H \"Content-Type: application/json\" \\\n  -H \"Authorization: Bearer YOUR_TOKEN\" \\\n  -d '{\"name\":\"<script>alert('xss')</script>\",\"email\":\"test@example.com\"}'\n```\n\n## Troubleshooting\n\n### Common Issues\n\n1. **CORS Errors**: Check `FRONTEND_URL` in environment variables\n2. **Rate Limiting**: Adjust limits in development mode\n3. **JWT Errors**: Verify `JWT_SECRET` is set correctly\n4. **Stripe Webhooks**: Ensure `STRIPE_WEBHOOK_SECRET` matches Stripe dashboard\n\n### Debug Mode\n\nEnable debug logging:\n\n```bash\nLOG_LEVEL=debug\nDEBUG_MODE=true\n```\n\n## Security Checklist\n\n- [ ] All environment variables configured\n- [ ] HTTPS enabled in production\n- [ ] Rate limiting configured\n- [ ] CSRF protection enabled\n- [ ] Input validation implemented\n- [ ] Audit logging configured\n- [ ] Payment security verified\n- [ ] RBAC policies defined\n- [ ] Security headers enabled\n- [ ] File upload restrictions set\n- [ ] Database queries parameterized\n- [ ] Error handling implemented\n- [ ] Security monitoring set up\n\n## Support\n\nFor security-related questions or issues:\n\n1. Check the logs in `./logs/` directory\n2. Review audit logs for security events\n3. Verify environment configuration\n4. Test with debug mode enabled\n\n---\n\n**Note**: This security implementation provides enterprise-grade protection but should be regularly reviewed and updated based on evolving security threats and best practices.